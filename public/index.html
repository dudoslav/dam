<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DAM</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <header>
      <h1>DAM</h1>
    </header>

    <nav>
      <form name="download-form" onsubmit="onDownloadSubmit(this); return false">
        <input type="text" name="url" placeholder="https://"><input type="submit" value="Submit">
      </form>
    </nav>

    <ul id="downloads-list">
    </ul>

    <script type="text/javascript">
      let downloads_list = document.getElementById('downloads-list')

      function onDownloadSubmit(form) {
        fetch('/downloads', { method: 'POST', body: JSON.stringify({ uri: form['url'].value }) })
          .then(refreshDownloads)
        form.reset()
      }

      function onDownloadDelete(id) {
        fetch(`/downloads/${id}`, { method: 'DELETE' })
        document.getElementById(id).remove()
      }

      function renderDownloads(downloads) {
        downloads.forEach(d => {
          let e = document.getElementById(d.id)
          if (e) updateDownloadsListItem(d, e)
          else downloads_list.appendChild(createDownloadsListItem(d))
        });
        [...downloads_list.children]
          .filter(li => !downloads.find(d => li.id == d.id))
          .forEach(li => li.remove())
      }

      function humanifySize(bytes) {
        let suffixes = ['', 'K', 'M', 'G', 'T']
        let suffix_index = 0
        let size = bytes

        while (size / 1000 > 1 && suffix_index < suffixes.length) {
          size = Math.floor(size / 1000)
          suffix_index++
        }

        return `${size} ${suffixes[suffix_index]}B`
      }

      function updateDownloadsListItem(download, li) {
        li.getElementsByTagName('progress')[0].value = download.current
        li.getElementsByTagName('progress')[0].max = download.size
        document.getElementById(`${download.id}_size`).innerHTML = humanifySize(download.size)
      }

      function createDownloadsListItem(download) {
        let e = document.createElement('li')
        e.id = download.id
        e.innerHTML = `
          <details>
            <summary>
              <span>${download.name}</span>
              <button class="delete-button" onclick="onDownloadDelete('${download.id}')">&#x00d7;</button>
              <progress value="${download.current}" max="${download.size}"></progress>
            </summary>
            <div class="flex-container">
              <div>URL: ${download.uri}</div>
              <div>SIZE: <span id="${download.id}_size">${humanifySize(download.size)}</span></div>
              <div>LOCATION: ${download.path}</div>
            </div>
          </details>
        `
        return e
      }

      function refreshDownloads() {
        fetch('/downloads').then(r => r.json()).then(json => renderDownloads(json))
      }

      let refreshInterval = setInterval(refreshDownloads, 2000)
    </script>
  </body>
</html>
